---
# Joplin is an excellent open source note taking application with plenty of features. You can take notes, make to-do list and sync your notes across devices
# TO DO: Check db port works without mapping and remove ports if it does
version: "3.8"
networks:
  t2_proxy:
    external: true
volumes:
  joplin-db-data:
  joplin-db-log:
    driver_opts:
      type: tmpfs
      device: tmpfs
  joplin-log:
    driver_opts:
      type: tmpfs
      device: tmpfs
services:
  joplin:
    image: joplin/server:${JOPLIN_VERSION}
    container_name: joplin
    restart: ${RESTART_POLICY}
    environment:
      - APP_PORT=22300
      - APP_BASE_URL=${JOPLIN_SUBDOMAIN}.${CLOUDFLARE_DOMAIN}
      - DB_CLIENT=pg
      - POSTGRES_PASSWORD=${JOPLINDB_PASS}
      - POSTGRES_DATABASE=${JOPLIN_POSTGRES_DATABASE}
      - POSTGRES_USER=${JOPLINDB_USER}
      - POSTGRES_PORT=5432
      - POSTGRES_HOST=joplin-db
    labels:
      - traefik.enable=true
      - traefik.http.services.whiteboard-https.loadbalancer.server.port=22300
      - traefik.http.routers.whiteboard-https.entrypoints=https
      - traefik.http.routers.whiteboard-https.rule=Host(`${JOPLIN_SUBDOMAIN}.${CLOUDFLARE_DOMAIN}`)
      - traefik.http.routers.whiteboard-https.tls=true
      - traefik.http.routers.whiteboard-https.tls.certresolver=myresolver
      - traefik.http.routers.whiteboard-https.middlewares=authelia@docker
    volumes:
      - joplin-log:/var/log
    networks:
      t2_proxy:
    depends_on:
      joplin-db
  joplin-db:
    image: postgres:13
    container_name: joplin-db
    hostname: joplin-db
    volumes:
      - joplin-db-data:/var/lib/postgresql
      - joplin-db-log:/var/log
#    ports:
#      - "${JOPLINDB_PORT}:5432"
    restart: ${RESTART_POLICY}
    environment:
      - POSTGRES_PASSWORD=${JOPLINDB_PASS}
      - POSTGRES_USER=${JOPLINDB_USER}
      - POSTGRES_DB=${JOPLIN_POSTGRES_DATABASE}
